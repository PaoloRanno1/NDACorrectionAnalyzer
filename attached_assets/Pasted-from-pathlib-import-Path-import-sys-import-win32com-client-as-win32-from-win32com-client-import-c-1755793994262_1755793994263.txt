from pathlib import Path
import sys
import win32com.client as win32
from win32com.client import constants
def compare_docs(original_path, revised_path, output_path, author_tag="AI Reviewer"):
    """
    Create a tracked-changes .docx by comparing two Word documents using
    Microsoft Word's built-in comparison engine.
    """
    original = str(Path(original_path).resolve())
    revised = str(Path(revised_path).resolve())
    output = str(Path(output_path).resolve())

    word = win32.gencache.EnsureDispatch("Word.Application")
    word.Visible = False
    word.DisplayAlerts = 0  # wdAlertsNone

    doc1 = doc2 = result = None
    try:
        doc1 = word.Documents.Open(original, ReadOnly=True)
        doc2 = word.Documents.Open(revised, ReadOnly=True)

        # This calls the same engine as Review → Compare
        result = word.CompareDocuments(
            OriginalDocument=doc1,
            RevisedDocument=doc2,
            Destination=constants.wdCompareDestinationNew,
            Granularity=constants.wdGranularityWordLevel,
            CompareFormatting=True,
            CompareCaseChanges=True,
            CompareWhitespace=True,
            CompareTables=True,
            CompareHeaders=True,
            CompareFootnotes=True,
            CompareTextboxes=True,
            CompareFields=True,
            CompareComments=True,
            RevisedAuthor=author_tag,
            IgnoreAllComparisonWarnings=True,
        )

        # Ensure markup is visible when opened
        result.TrackRevisions = True
        result.ShowRevisions = True

        # Save as .docx
        result.SaveAs2(output, FileFormat=constants.wdFormatXMLDocument)
        print(f"✅ Redline saved to: {output}")

    finally:
        # Close comparison doc first (if created)
        if result is not None:
            try:
                result.Close(SaveChanges=False)
            except Exception:
                pass
        # Close originals without saving
        for d in (doc1, doc2):
            if d is not None:
                try:
                    d.Close(SaveChanges=False)
                except Exception:
                    pass
        word.Quit()